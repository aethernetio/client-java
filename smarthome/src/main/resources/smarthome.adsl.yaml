# ===================================================================
# SmartHome Protocol Definition (P2P / Mesh Version)
# GUI общается напрямую с Коммутатором.
# ===================================================================

types:
  # -----------------------------------------------------------------
  # VariantData (Tagged Union) для типизированных данных
  # -----------------------------------------------------------------
  VariantData:
    doc: Абстрактный базовый класс для передачи типизированных данных.
    abstract: true

  VariantBool:
    parent: VariantData
    id: 1
    fields:
      value: bool

  VariantLong:
    parent: VariantData
    id: 2
    doc: Используется для всех целых чисел (byte, short, int, long).
    fields:
      value: long

  VariantDouble:
    parent: VariantData
    id: 3
    doc: Используется для всех чисел с плавающей запятой (float, double).
    fields:
      value: double

  VariantString:
    parent: VariantData
    id: 4
    fields:
      value: String

  VariantBytes:
    parent: VariantData
    id: 5
    doc: Для передачи сложных бинарных данных.
    fields:
      value: byte[]

  # -----------------------------------------------------------------
  # State DTO
  # -----------------------------------------------------------------
  DeviceStateData:
    doc: Структура состояния (значение + метка времени).
    fields:
      payload: VariantData
      timestamp: Date

  # -----------------------------------------------------------------
  # Hardware DTOs
  # -----------------------------------------------------------------
  HardwareDevice:
    doc: Базовый тип физического устройства на коммутаторе.
    abstract: true
    fields:
      localId: int
      descriptor: String

  HardwareSensor:
    parent: HardwareDevice
    id: 1
    constants:
      hardwareType: "SENSOR"
    fields:
      unit: String?

  HardwareActor:
    parent: HardwareDevice
    id: 2
    constants:
      hardwareType: "ACTOR"

  # -----------------------------------------------------------------
  # Streams
  # -----------------------------------------------------------------
  SmartHomeCommutatorStream:
    stream:
      api: "SmartHomeCommutatorApi"
      crypto: true
  SmartHomeClientStream:
    stream:
      api: "SmartHomeClientApi"
      crypto: true

# ===================================================================
# API Interface Definitions
# ===================================================================

api:

  # -----------------------------------------------------------------
  # API Implemented by the COMMUTATOR
  # GUI вызывает эти методы напрямую по P2P.
  # -----------------------------------------------------------------
  SmartHomeCommutatorApi:
    doc: The API implemented by each Commutator.
    methods:

      getSystemStructure:
        doc: Запрашивает список всех физических устройств на этом коммутаторе.
        id: 10
        returns: HardwareDevice[]

      executeActorCommand:
        doc: Отправить команду на конкретный актуатор.
        id: 4
        params:
          localActorId: int
          command: VariantData
        returns: DeviceStateData

      queryState:
        doc: Запросить текущее состояние конкретного устройства.
        id: 5
        params:
          localDeviceId: int
        returns: DeviceStateData

      queryAllSensorStates:
        doc: Попросить коммутатор прислать PUSH-уведомления о состоянии всех датчиков.
        id: 6

  # -----------------------------------------------------------------
  # API Implemented by the CLIENT (GUI)
  # Коммутатор вызывает эти методы (PUSH).
  # -----------------------------------------------------------------
  SmartHomeClientApi:
    doc: The API implemented by the GUI Client.
    methods:
      deviceStateUpdated:
        doc: Уведомление от коммутатора об изменении состояния.
        id: 3
        params:
          localDeviceId: int # Коммутатор знает только локальный ID
          state: DeviceStateData